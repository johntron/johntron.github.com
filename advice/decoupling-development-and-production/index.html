
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Decoupling development and production code - Johntron.com</title>
  <meta name="author" content="John Syrinek">

  
  <meta name="description" content="I use Subversion to deploy web applications using a simple svn update command on a production server. This is really convenient, but something has &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://johntron.github.com/advice/decoupling-development-and-production/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Johntron.com" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Johntron.com</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:johntron.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Decoupling Development and Production Code</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-09T00:00:00-05:00" pubdate data-updated="true">Mar 9<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I use Subversion to deploy web applications using a simple <code>svn update</code> command on a production server. This is really convenient, but something has always bothered me. Domain names for production servers are never the same as the development servers. This is true regardless of whether you use PHP, Python, Ruby, or something else. For this reason, deploying is never as easy as typing <code>svn update</code>.</p>

<p>This specific problem is fairly new to computer science, because server-side scripting languages are relatively new in the whole scheme of things. I’ve done some research, and I’ve documented the most elegant solution I could come up with to minimize the possibility of human error from the deployment process. As a professional web developer, this method has saved me many headaches and lots of man hours.</p>

<p class="list_header">
  Here are the highlights:
</p>


<ul>
<li>Machine independent</li>
<li>Language independent</li>
<li>Easy to deploy</li>
<li>Easy to setup</li>
<li>Maintenance free (no tweaking during the deployment phase)</li>
<li>Standard (available on most systems)</li>
</ul>


<p>This system uses <code>m4</code> and <code>make</code>. <code>m4</code> is tool used to generate code from macros (among other things). Using m4 means we can do things similar to preprocessor directives in C languages. Make is a build tool used for generating non-source files from source files. Using make means we can generate one set of files for a development environment, and one set of files for a production environment. This system is very common, and has been around for years, so there should be plenty of documentation out there.</p>

<p class="list_header">
  After setting up this build system, deployment would work like this:
</p>


<ol>
<li>From a development server, commit changes to a Subversion repository</li>
<li>From a production server, update a working copy</li>
<li>Run `make`</li>
</ol>


<p>I will not discuss Subversion, as this is covered elsewhere. I’ll assume you know this, so let’s get started by creating an m4 file.</p>

<h3>m4 as a Preprocessor</h3>

<p>Ideally, all of the machine-specific settings should be stored in a single file. This is often called a config file or a settings file. In my case, the file is named “settings.py”, because I’m writing some software using Django. To decouple the machine-specific code, I will need to be able to write macros in settings.py. To do this, I rename the file to “settings.py.m4″. The m4 extension is used to denote files that should be processed with m4 (clearly). After renaming the file, I can use whatever macros I want. The most useful macro is a simple <code>if…else…</code> function called <code>ifdef()</code>.</p>

<p class="list_header">
  The most common <code>ifdef()</code> macro will look like this:
</p>


<pre><code>ifdef(`debug', `True', `False')
</code></pre>

<p>m4 would replace this statement with <code>True</code> or <code>False</code> based on whether or not <code>debug</code> is defined. The true power of this is made apparent when you start assigning URLs to variable.</p>

<p class="list_header">
  For instance, imagine a file that contains this line of code:
</p>


<pre><code>DEBUG = True
</code></pre>

<p>This <code>DEBUG</code> variable could be used to control output and logging. Clearly, debug should never be enabled on a production server (gross). So how would you account for two different environments? The most straightforward solution would be to manually edit this file after each <code>svn update</code> or perhaps have Subversion ignore this file. By manually editing this file each time, you are assuming you’ll remember to do this. By ignoring this file from Subversion, you’re throwing out all the benefits of version control.</p>

<p class="list_header">
  So here is where m4 comes in. Replace the line of code listed above with this:
</p>


<pre><code>DEBUG = ifdef(`debug', `True', `False')
</code></pre>

<p class="list_header">
  Notice that <code>debug</code> is not defined yet (not to be confused with <code>DEBUG</code>). If we were to run m4 on this file, this line would end up looking like this:
</p>


<pre><code>DEBUG = False
</code></pre>

<p class="list_header">
  So now we just need to define “debug” at a higher level. The best place for this is at the command line. With m4, you can define variables on the command line. Use the <code>-D</code> flag to accomplish this. In our case we would type something like this (from the command line): <code>m4 -D debug settings.py.m4</code>. After hitting enter, you would see the entire settings.py.m4 file output to the shell. If you look carefully, you should see the following:
</p>


<pre><code>DEBUG = True
</code></pre>

<p class="list_header">
  Try running the same command again, but without the <code>-D debug </code> this time. You should see:
</p>


<pre><code>DEBUG = False
</code></pre>

<p>When you’re done learning about m4, run the command one last time, but this time save the output to a file by running this command: <code>m4 -D debug settings.py.m4 &gt; settings.py</code> Now we’ve decoupled our machine-specific code and can control it from the command line. The last step is to make things a little easier to remember. <code>make</code> is great for this, because it allows us to create build targets.</p>

<h3>Deploying web software with make</h3>

<p>A target is simply a final copy of an application. In our case, we will have a development target and a production target. Begin simplifying things by creating a file name “Makefile” in the highest level directory of your source code. This file is used by make to determine what needs to be done for any given build target. The syntax of this file is pretty simple.</p>

<p class="list_header">
  My Makefile looks like this:
</p>


<pre><code>live:
    m4 placethings/settings.py.m4 &gt; placethings/settings.py

development:
    m4 -D debug placethings/settings.py.m4 &gt; placethings/settings.py
</code></pre>

<p>This file defines two targets: <code>live</code> and <code>development</code>. To build a target, we type: <code>make [target]</code>. Make assumes the first target is the default, so we can just type <code>make</code>, and “settings.py.m4″ would be processed for a production environment and saved to “settings.py”. Alternatively, we could type <code>make development</code> and “settings.py.m4″ would be processed for a development environment and saved to “settings.py”.</p>

<p>The last step is to put these files under version control along with everything else ( using <code>svn add</code>). If you wanted to, you could even go one step further and add <code>svn update</code> to your Makefile. There are advantages and disadvantes to this. I prefer not to do this, because anything that happens during the update process can affect the rest of the build process.</p>

<p>Clearly, I’m passionate about removing the possiblity of human error. Some might say this is obsessive, but I say it’s what makes good software great. Now, instead of potentially spewing code traces at your users without realizing it everytime you change your code, you just have to make sure your build process works next time you use an <code>ifdef()</code> in your settings.py.m4 file. This is much easier to do than trying to trigger an exception on the production server.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Johntron</span></span>

      








  


<time datetime="2009-03-09T00:00:00-05:00" pubdate data-updated="true">Mar 9<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/advice/'>Advice</a>, <a class='category' href='/blog/categories/mobile/'>mobile</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://johntron.github.com/advice/decoupling-development-and-production/" data-via="johntron" data-counturl="http://johntron.github.com/advice/decoupling-development-and-production/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/advice/the-brick-wall/" title="Previous Post: The brick wall">&laquo; The brick wall</a>
      
      
        <a class="basic-alignment right" href="/advice/blog-guidelines/" title="Next Post: Blog guidelines">Blog guidelines &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/hacking/ubuntu-12-boot-process-explained/">Ubuntu 12 boot process explained</a>
      </li>
    
      <li class="post">
        <a href="/advice/effective-graph-layout/">Effective Graph Layout</a>
      </li>
    
      <li class="post">
        <a href="/programming/better-logging-with-loggly-and-symfony-2/">Better logging with Loggly and Symfony 2</a>
      </li>
    
      <li class="post">
        <a href="/advice/dell-design-library/">DELL Design Library</a>
      </li>
    
      <li class="post">
        <a href="/mobile/how-to-root-a-kindle-fire-on-os-x/">How to root a Kindle Fire on OS X</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/johntron">@johntron</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'johntron',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("johntron", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/johntron" class="twitter-follow-button" data-show-count="false">Follow @johntron</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/johntron?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - John Syrinek -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
